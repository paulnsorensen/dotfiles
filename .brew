#!/bin/bash
############################
# .brew
# Installs packages from brew/packages.yaml
############################

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PACKAGES_FILE="$SCRIPT_DIR/brew/packages.yaml"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

if [ "${QUICK_SYNC:-false}" = "true" ]; then
  echo "Quick sync, skipping brew"
  exit 0
fi

# Install brew if not present
if ! command -v brew &> /dev/null; then
    echo -e "${BLUE}Installing Homebrew...${NC}"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
else
    echo -e "${BLUE}Updating Homebrew...${NC}"
    brew update
fi

# Check for yq (needed to parse YAML)
if ! command -v yq &> /dev/null; then
    echo -e "${YELLOW}Installing yq (needed to parse packages.yaml)...${NC}"
    brew install yq
fi

if [[ ! -f "$PACKAGES_FILE" ]]; then
    echo -e "${YELLOW}Warning: $PACKAGES_FILE not found${NC}"
    exit 0
fi

echo -e "${BLUE}Reading packages from $PACKAGES_FILE${NC}"

# Add taps
if yq -e '.taps' "$PACKAGES_FILE" > /dev/null 2>&1; then
    echo -e "\n${GREEN}Taps:${NC}"
    for tap in $(yq -r '.taps[]' "$PACKAGES_FILE" 2>/dev/null); do
        if brew tap | grep -q "^${tap}$"; then
            echo "  ✓ $tap (tapped)"
        else
            echo "  Tapping $tap..."
            brew tap "$tap"
        fi
    done
fi

# Install core formulae
echo -e "\n${GREEN}Core formulae:${NC}"
for package in $(yq -r '.formulae[]' "$PACKAGES_FILE" 2>/dev/null); do
    if brew ls --versions "$package" > /dev/null 2>&1; then
        echo "  ✓ $package (installed)"
    else
        echo "  Installing $package..."
        brew install "$package"
    fi
done

# Install core casks (if any)
if yq -e '.casks' "$PACKAGES_FILE" > /dev/null 2>&1; then
    echo -e "\n${GREEN}Casks:${NC}"
    for cask in $(yq -r '.casks[]' "$PACKAGES_FILE" 2>/dev/null); do
        if brew ls --cask --versions "$cask" > /dev/null 2>&1; then
            echo "  ✓ $cask (installed)"
        else
            echo "  Installing $cask..."
            brew install --cask "$cask"
        fi
    done
fi

# Install dev packages if DOTFILES_DEV=true
if [ "${DOTFILES_DEV:-false}" = "true" ]; then
    echo -e "\n${GREEN}Dev formulae:${NC}"
    for package in $(yq -r '.dev_formulae[]' "$PACKAGES_FILE" 2>/dev/null); do
        if brew ls --versions "$package" > /dev/null 2>&1; then
            echo "  ✓ $package (installed)"
        else
            echo "  Installing $package..."
            brew install "$package"
        fi
    done

    if yq -e '.dev_casks' "$PACKAGES_FILE" > /dev/null 2>&1; then
        echo -e "\n${GREEN}Dev casks:${NC}"
        for cask in $(yq -r '.dev_casks[]' "$PACKAGES_FILE" 2>/dev/null); do
            if brew ls --cask --versions "$cask" > /dev/null 2>&1; then
                echo "  ✓ $cask (installed)"
            else
                echo "  Installing $cask..."
                brew install --cask "$cask"
            fi
        done
    fi
fi

echo -e "\n${GREEN}Homebrew sync complete!${NC}"
