name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install bats
      run: |
        sudo npm install -g bats
    
    - name: Run tests
      run: ./tests/run-tests.sh
    
    - name: Test git hooks
      run: |
        # Test that pre-commit hook blocks secrets
        git config user.email "test@example.com"
        git config user.name "Test User"
        git config core.hooksPath ./githooks
        # Build test string to avoid triggering our own hook
        printf '%s="%s"\n' "password" "secret" > test-secret.sh
        git add test-secret.sh
        ! git commit -m "test" 2>/dev/null || exit 1
        echo "âœ… Pre-commit hook correctly blocked secret"
  
  shellcheck:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Run ShellCheck
      uses: ludeeus/action-shellcheck@master
      with:
        scandir: './bin'
        additional_files: '.sync .sync-with-rollback'
        ignore_paths: './tests'
        format: gcc
